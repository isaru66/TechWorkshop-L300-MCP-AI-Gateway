{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "<a href=\"https://github.com/Azure-Samples/AI-Gateway/blob/main/labs/finops-framework/finops-framework.ipynb\" target=\"_blank\"><img src=\"https://raw.githubusercontent.com/Azure-Samples/AI-Gateway/refs/heads/main/images/finops-framework-small.gif\"/></a>\n\n# APIM❤️AI Foundry - FinOps Dashboard\n\n---"
      },
      "name": "header-markdown"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let llmHeaderLogs = ApiManagementGatewayLlmLog\r\n| where TimeGenerated >= startofmonth(now()) and TimeGenerated <= endofmonth(now())\r\n| where DeploymentName != \"\";\r\nlet llmLogsWithSubscriptionId = llmHeaderLogs\r\n| join kind=leftouter ApiManagementGatewayLogs on CorrelationId\r\n| project\r\n    SubscriptionName = ApimSubscriptionId, DeploymentName, PromptTokens, CompletionTokens, TotalTokens;\r\nllmLogsWithSubscriptionId\r\n| join kind=inner (\r\n    PRICING_CL\r\n    | summarize arg_max(TimeGenerated, *) by Model\r\n    | project Model, InputTokensPrice, OutputTokensPrice\r\n    )\r\n    on $left.DeploymentName == $right.Model\r\n| extend InputCost = PromptTokens * InputTokensPrice\r\n| extend OutputCost = CompletionTokens * OutputTokensPrice\r\n| summarize\r\n    InputCost = sum(InputCost), OutputCost = sum(OutputCost)\r\n    by SubscriptionName\r\n| extend TotalCost = (InputCost + OutputCost) / 1000\r\n| join kind=inner (\r\n    SUBSCRIPTION_QUOTA_CL\r\n    | summarize arg_max(TimeGenerated, *) by Subscription\r\n    | project Subscription, CostQuota\r\n) on $left.SubscriptionName == $right.Subscription\r\n| project SubscriptionName, CostQuota, TotalCost\r\n\r\n",
        "size": 0,
        "title": "Budget analysis by subscription",
        "timeContext": {
          "durationMs": 86400000
        },
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "barchart",
        "chartSettings": {
          "xAxis": "SubscriptionName",
          "yAxis": ["CostQuota", "TotalCost"],
          "showLegend": true,
          "legendPosition": "Bottom"
        }
      },
      "customWidth": "50",
      "name": "budget-analysis-chart"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let llmHeaderLogs = ApiManagementGatewayLlmLog\n| where DeploymentName != '';\nlet llmLogsWithSubscriptionId = llmHeaderLogs\n| join kind=leftouter ApiManagementGatewayLogs on CorrelationId\n| project\n    SubscriptionName = ApimSubscriptionId, DeploymentName, PromptTokens, CompletionTokens, TotalTokens;\nllmLogsWithSubscriptionId\n| join kind=inner (\n    PRICING_CL\n    | summarize arg_max(TimeGenerated, *) by Model\n    | project Model, InputTokensPrice, OutputTokensPrice\n    )\n    on $left.DeploymentName == $right.Model\n| extend InputCost = PromptTokens * InputTokensPrice\n| extend OutputCost = CompletionTokens * OutputTokensPrice\n| summarize\n    InputCost = sum(InputCost), OutputCost = sum(OutputCost)\n    by SubscriptionName\n| extend TotalCost = (InputCost + OutputCost) / 1000\n| project SubscriptionName, TotalCost\n\n",
        "size": 0,
        "title": "Token usage by subscription",
        "timeContext": {
          "durationMs": 86400000
        },
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "piechart",
        "chartSettings": {
          "showLegend": true,
          "legendPosition": "Bottom"
        }
      },
      "customWidth": "50",
      "name": "token-usage-donut"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let llmHeaderLogs = ApiManagementGatewayLlmLog\n| where DeploymentName != '';\nlet llmLogsWithSubscriptionId = llmHeaderLogs\n| join kind=leftouter ApiManagementGatewayLogs on CorrelationId\n| project\n    TimeGenerated, SubscriptionName = ApimSubscriptionId, DeploymentName, PromptTokens, CompletionTokens, TotalTokens;\nllmLogsWithSubscriptionId\n| join kind=inner (\n    PRICING_CL\n    | summarize arg_max(TimeGenerated, *) by Model\n    | project Model, InputTokensPrice, OutputTokensPrice\n    )\n    on $left.DeploymentName == $right.Model\n| extend InputCost = PromptTokens * InputTokensPrice\n| extend OutputCost = CompletionTokens * OutputTokensPrice\n| summarize\n    InputCost = sum(InputCost), OutputCost = sum(OutputCost)\n    by SubscriptionName, bin(TimeGenerated, 1m)\n| extend TotalCost = (InputCost + OutputCost) / 1000\n| project TimeGenerated, SubscriptionName, TotalCost\n\n",
        "size": 0,
        "title": "Token usage over time",
        "timeContext": {
          "durationMs": 43200000
        },
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "barchart",
        "chartSettings": {
          "xAxis": "TimeGenerated",
          "yAxis": ["TotalCost"],
          "group": "SubscriptionName",
          "showLegend": true,
          "legendPosition": "Bottom"
        }
      },
      "name": "token-usage-overtime"
    },
    {
      "type": 10,
      "content": {
        "chartId": "workbookCostAnalysis",
        "version": "MetricsItem/2.0",
        "size": 3,
        "chartType": 2,
        "resourceType": "microsoft.insights/components",
        "metricScope": 0,
        "resourceParameter": "appInsightsResource",
        "resourceIds": [
          "{appInsightsResource}"
        ],
        "timeContext": {
          "durationMs": 86400000
        },
        "metrics": [
          {
            "namespace": "microsoft.insights/components",
            "metric": "microsoft.insights/components--Server-requests",
            "aggregation": 7,
            "splitBy": null
          }
        ],
        "title": "Server requests",
        "gridSettings": {
          "rowLimit": 10000
        }
      },
      "customWidth": "33",
      "name": "server-requests-metric"
    },
    {
      "type": 10,
      "content": {
        "chartId": "workbookResponseTime",
        "version": "MetricsItem/2.0",
        "size": 3,
        "chartType": 2,
        "resourceType": "microsoft.insights/components",
        "metricScope": 0,
        "resourceParameter": "appInsightsResource",
        "resourceIds": [
          "{appInsightsResource}"
        ],
        "timeContext": {
          "durationMs": 86400000
        },
        "metrics": [
          {
            "namespace": "microsoft.insights/components",
            "metric": "microsoft.insights/components--Server-response time",
            "aggregation": 4,
            "splitBy": null
          }
        ],
        "title": "Server response time",
        "gridSettings": {
          "rowLimit": 10000
        }
      },
      "customWidth": "33",
      "name": "server-response-metric"
    },
    {
      "type": 10,
      "content": {
        "chartId": "workbookFailedRequests",
        "version": "MetricsItem/2.0",
        "size": 3,
        "chartType": 2,
        "resourceType": "microsoft.insights/components",
        "metricScope": 0,
        "resourceParameter": "appInsightsResource",
        "resourceIds": [
          "{appInsightsResource}"
        ],
        "timeContext": {
          "durationMs": 86400000
        },
        "metrics": [
          {
            "namespace": "microsoft.insights/components",
            "metric": "microsoft.insights/components--Server-Failed requests",
            "aggregation": 7,
            "splitBy": null
          }
        ],
        "title": "Failed requests",
        "gridSettings": {
          "rowLimit": 10000
        }
      },
      "customWidth": "33",
      "name": "failed-requests-metric"
    }
  ],
  "fallbackResourceIds": [
    "{workspace-id}"
  ],
  "fromTemplateId": "community-Workbooks/FinOps/FinOps Dashboard",
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}